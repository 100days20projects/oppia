{% extends "base.html" %}

{% block content %}
  <canvas id="dummyCanvas" width="0" height="0"></canvas>

  <div ng-controller="QuestionEditor" class="content-body" ng-cloak>
    <div>
      <div class="content" id="top-pane">
        <div class="left-col">
          <h3>Question Name</h3>
          <form ng-submit="saveQuestionName()">
            <h3 class="question-name" ng-hide="currentActiveInput == 'questionName'" ng-click="initializeNewActiveInput('questionName')"> <[question.desc]> </h3>
            <span ng-show="currentActiveInput == 'questionName'">
              <input style="width: 60%" type="text" ng-model="question.desc" required>
              <input type="submit" value="Save">
            </span>
            <span class="loading" ng-show="saveQuestionNameLoading"></span>
          </form>

          <br>

          <form ng-submit="addState(newStateDesc, false)">
            <input style="width: 80%" type="text" list="states" ng-model="newStateDesc" placeholder="Add State" required>
            <datalist id="states">
              <option ng-repeat="(id, properties) in states | orderBy:'properties.desc':true" value="<[properties.desc]>"></option>
            </datalist>
            <div class="loading" ng-show="addStateLoading"></div>
          </form>

          <div id="state-graph-container">
            <div id="state-graph-canvas">
            </div>
          </div>
        </div>

        <div class="right-col">
          <div ng-repeat="warning in warnings">
            <p class="butterbar">
              <[warning]>
            </p>
          </div>

          <div id="editorWindow" ng-show="stateId">
            <a class="close-button" ng-click="closeEditorWindow()">&times;</a>
            <form ng-submit="saveStateName()">
              <h3>
                <[question.desc]>
                <span style="color: #aaa;"> : </span>
                <span class="state-name" ng-hide="currentActiveInput == 'stateName'" ng-click="initializeNewActiveInput('stateName')"> <[stateName]> </span>
                <span ng-show="currentActiveInput == 'stateName'">
                  <input type="text" ng-model="stateName">
                  <input type="submit" value="Save">
                </span>
              </h3>
            </form>

            <h4>Content displayed to the reader</h4>

            <center class="help-box" ng-show="stateText.length == 0">
              To add content, drag an icon from the palette on the right into the box below.
            </center>

            <div>
              <ul ui-sortable ng-model="stateText" class="sortable state-text-list">
                <!--TODO(sll): When these are moved around, the containing boxes get smaller. Why?-->
                <li ng-repeat="item in stateText" class="state-text-item" ng-class="'item-' + $index">
                  <ng-switch on="item.type">
                    <!-- TODO(sll): In the following, stateText should store the
                    raw HTML. When the user clicks to edit, the textarea should
                    convert <br> into newlines, and when the user saves, the
                    newlines should be converted into <br>'s. Tags like < and >
                    also need to be HTML-ified. Maybe use a contenteditable? -->
                    <div ng-switch-when="text">
                      <ng-switch on="currentActiveInput == 'stateText.' + $index">
                        <div ng-switch-when="true">
                          <textarea rows="5" ng-model="item.value" unfocus-state-text="clearActiveInputs()"></textarea>
                        </div>
                        <div ng-switch-default ng-click="initializeNewActiveInput('stateText.' + $index)">
                          <ng-switch on="item.value == ''">
                            <div ng-switch-when="true" class="placeholder">
                              You can enter text here.
                            </div>
                          </ng-switch>
                          <span ng-bind-html="item.value"></span>
                        </div>
                      </ng-switch>
                    </div>

                    <div ng-switch-when="image">
                      <ng-switch on="item.value == ''">
                        <div ng-switch-when="true" class="placeholder">
                          <form id="newImageForm">
                            Upload an image:
                            <input type="file" id="newImage" name="newImage" imageupload="true">
                            <button type="button" ng-click="saveImage($index)">Save</button>
                          </form>
                          <span class="loading" id="uploadImageLoading"></span>
                        </div>
                        <div ng-switch-default>
                          <img class="small-image" ng-src="/editor/images/<[item.value]>"></img>
                          <span ng-click="deleteImage($index)" class="image-thumbnail">&times;</span>
                        </div>
                      </ng-switch>
                    </div>

                    <div ng-switch-when="video">
                      <ng-switch on="item.value == ''">
                        <div ng-switch-when="true" class="placeholder">
                          <form ng-submit="hideVideoInputDialog(newVideoLink, $index)">
                            Add a Youtube video link:
                            <input type="text" ng-model="newVideoLink" id="newVideoLink">
                            <input type="submit" value="Save">
                          </form>
                        </div>
                        <div ng-switch-default>
                          <iframe width="100" height="56" src="http://www.youtube.com/embed/<[item.value]>?rel=0" frameborder="0" allowfullscreen></iframe>
                          <span ng-click="deleteVideo($index)" class="video-thumbnail">&times;</span>
                        </div>
                      </ng-switch>
                    </div>

                    <div ng-switch-when="widget">
                      <input type="radio" ng-model="widgetDisplay" id="widgetCodeOption" value="code">
                      <label for="widgetCodeOption">Code</label>
                      <input type="radio" ng-model="widgetDisplay" id="widgetCompiledOption" value="compiled">
                      <label for="widgetCompiledOption">Compiled</label>
                      <input type="radio" ng-model="widgetDisplay" id="widgetRepositoryOption" value="repository">
                      <label for="widgetRepositoryOption">Repository</label>
                      <div ng-show="widgetDisplay == 'code'">
                        Upload a widget:
                        <textarea class="code" ng-model="widgetCode" rows="30"></textarea>
                        <button type="button" ng-click="saveWidget(widgetCode, $index)">Save</button>
                      </div>
                      <div ng-show="widgetDisplay == 'compiled'">
                        <div id="widgetCompiled"></div>
                      </div>
                      <div ng-show="widgetDisplay == 'repository'">
                        <iframe src="/widgets/repository/"></iframe>
                      </div>
                    </div>

                  </ng-switch>
                </li>
              </ul>

              <center class="add-content-box palette-droppable">
                Drag Content Here
              </center>
              <br>
            </div>

            <h4 ng-show="inputType != 'none'">
              Interaction: <[getReadableInputType(inputType)]>
              <span>
                (<a ng-click="changeInputType('none')">Remove</a>)
              </span>
            </h4>

            <div class="destinations">
              <div ng-show="inputType == 'none'">
                <div>
                  <span class="dest-name" ng-hide="currentActiveInput == 'none.0.dest'" ng-click="currentActiveInput = 'none.0.dest'">
                    <[getDestDescription(states[stateId]['dests'][0].dest)]>
                  </span>

                  <span ng-show="currentActiveInput == 'none.0.dest'">
                    <form ng-submit="saveDest(0, newNoneDestData)">
                      Destination:
                      <input type="none" size="40" list="destinations" ng-model="newNoneDestData" placeholder="Type name of state, or '[Q' for questions" required>
                      <datalist id="destinations">
                        <option ng-repeat="(id, properties) in states" value="<[properties.desc]>"></option>
                        <option ng-repeat="(id, properties) in questions" value="[Question] <[properties.desc]>"></option>
                        <option value="END"></option>
                      </datalist>
                      <input type="submit" value="Save">
                    </form>
                  </span>

                  <br>
                  <br>

                  <div>
                    <h5>Pick an input view:</h5>
                    <select class="firstInputField" ng-model="newInputType" id="newInputType" ng-change="changeInputType(newInputType)" ng-hide="currentActiveInput == 'none.0.dest'">
                      <option value="multiple_choice">Multiple Choice</option>
                      <option value="int">Integer</option>
                      <option value="set">Set</option>
                      <option value="text">Text</option>
                    </select>
                  </div>
                </div>
              </div>

              <div ng-show="inputType != 'none'">
                {{finite_code}}
                {{numeric_code}}
                {{set_code}}
                {{text_code}}
              </div>

              <div id="popup" ng-show="isModalWindowActive">
                <a class="close-button" ng-click="closeModalWindow()">&times;</a>
  
                <div class="editorInput" id="textInput">
                  <label for="textData">
                    <h5>In response to the reader's answer, display the text:</h5>
                  </label>
                  <textarea class="firstInputField" rows="10" cols="50" ng-model="textData" id="textData"> </textarea>
                  <p>
                    <button ng-click="saveText()">Save</button>
                 </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="palette" ng-show="stateId">
          <div class="palette-text palette-icon" title="Add text"></div>
          <div class="palette-image palette-icon" title="Add image"></div>
          <div class="palette-video palette-icon" title="Add video"></div>
          <div class="palette-widget palette-icon" title="Add interactive widget" ng-hide="isWidgetInStateText()"></div>

         <!-- The outer div below is needed to make the background color appear
         behind the image. -->
          <div class="item-droppable">
            <div class="palette-trash"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

{% endblock %}
