<div ng-controller="StateResponses">
  <div style="font-size: 16px; margin-top: 35px;">
    <strong>Learner's Answers and Oppia's Responses</strong>
  </div>

  <md-card class="oppia-editor-card-with-avatar">
    <div class="oppia-editor-card-body">
      <div ng-if="answerGroups.length > 0">
        <ul class="nav nav-stacked nav-pills" role="tablist" ui-sortable="ANSWER_GROUP_LIST_SORTABLE_OPTIONS" ng-model="answerGroups">
          <!-- An HTML element marked ui-sortable should contain only one element,
          and this element should have an ng-repeat defined on it. See the
          ui-sortable documentation for more details. -->
          <!-- Note that adding "track by $index" here seems to mess up the final
          index in the stop() event handler. -->
          <li ng-repeat="answerGroup in answerGroups" ng-class="{'active': activeAnswerGroupIndex === $index}" class="oppia-rule-block oppia-sortable-rule-block" style="margin-top: 0;">
            <span class="oppia-rule-sort-handle" ng-if="answerGroups.length > 1">
              <img ng-if="editabilityService.isEditable()" src="/images/general/drag_dots.png" width="10">
            </span>
            <a ng-click="changeActiveAnswerGroupIndex($index)" class="oppia-rule-tab protractor-test-response-tab" ng-class="{'oppia-rule-tab-active': activeAnswerGroupIndex === $index}">
              <div class="oppia-response-header-block">
                <div class="oppia-response-header">
                  <span ng-if="$index != activeAnswerGroupIndex" ng-attr-title="<[answerGroup | summarizeAnswerGroup:getCurrentInteractionId():getAnswerChoices():false]>">
                    <[answerGroup | summarizeAnswerGroup:getCurrentInteractionId():getAnswerChoices():true]>
                  </span>
                  <span ng-if="$index == activeAnswerGroupIndex">&nbsp;</span>
                </div>
                <span>→</span>
                <span ng-if="!isOutcomeLooping(answerGroup.outcome) && !isCreatingNewState(answerGroup.outcome)" ng-click="navigateToState(answerGroup.outcome.dest)" class="oppia-nested-link">
                  <[answerGroup.outcome.dest]>
                </span>
                <span ng-if="!isOutcomeLooping(answerGroup.outcome) && isCreatingNewState(answerGroup.outcome)">
                  <em ng-if="answerGroup.outcome.newStateName">(<[answerGroup.outcome.newStateName]>)</em>
                  <em ng-if="!answerGroup.outcome.newStateName">Nowhere yet...</em>
                </span>
                <span ng-if="isOutcomeLooping(answerGroup.outcome)">
                  <em>(try again)</em>
                </span>
              </div>
              <img src="/third_party/static/material-design-icons-1.0.1/ic_close_black_48dp.png" ng-if="editabilityService.isEditable()" class="protractor-test-delete-response oppia-delete-response-button oppia-transition-200" ng-click="deleteAnswerGroup($index, $event)">
            </a>

            <div ng-if="activeAnswerGroupIndex === $index">
              <div class="oppia-editor-card-section">
                <div class="oppia-rule-body-container protractor-test-response-body-<[$index]>">
                  <answer-group-editor rules="answerGroup.rule_specs" outcome="answerGroup.outcome" on-save-answer-group-feedback="saveActiveAnswerGroupFeedback(answerGroup.outcome)" on-save-answer-group-dest="saveActiveAnswerGroupDest(answerGroup.outcome)" on-save-answer-group-rules="saveActiveAnswerGroupRules(answerGroup.rule_specs)" is-editable="editabilityService.isEditable()" class="protractor-test-response-body">
                  </answer-group-editor>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div>
        <ul class="nav nav-stacked nav-pills" role="tablist">
          <li ng-class="{'active': activeAnswerGroupIndex === answerGroups.length}" class="oppia-rule-block">
            <a ng-click="changeActiveAnswerGroupIndex(answerGroups.length)" class="oppia-rule-tab oppia-default-rule-tab protractor-test-default-response-tab" ng-class="{'oppia-rule-tab-active': activeAnswerGroupIndex == answerGroups.length}">
              <div class="oppia-response-header-block">
                <div ng-attr-title="<[defaultOutcome | summarizeDefaultOutcome:getCurrentInteractionId():answerGroups.length:false]>" class="oppia-response-header">
                  <[defaultOutcome | summarizeDefaultOutcome:getCurrentInteractionId():answerGroups.length:true]>
                </div>
                <span>→</span>
                <span ng-if="!isOutcomeLooping(defaultOutcome) && !isCreatingNewState(defaultOutcome)" ng-click="navigateToState(defaultOutcome.dest)" class="oppia-nested-link">
                  <[defaultOutcome.dest]>
                </span>
                <span ng-if="!isOutcomeLooping(defaultOutcome) && isCreatingNewState(defaultOutcome)">
                  <em ng-if="defaultOutcome.newStateName">(<[defaultOutcome.newStateName]>)</em>
                  <em ng-if="!defaultOutcome.newStateName">Nowhere yet...</em>
                </span>
                <span ng-if="isOutcomeLooping(defaultOutcome)">
                  <em>(try again)</em>
                </span>
              </div>
            </a>

            <div ng-if="activeAnswerGroupIndex === answerGroups.length">
              <div class="oppia-editor-card-section">
                <div class="oppia-rule-body-container protractor-test-response-body-default">
                  <answer-group-editor rules="null" outcome="defaultOutcome" on-save-answer-group-feedback="saveDefaultOutcomeFeedback(defaultOutcome)" on-save-answer-group-dest="saveDefaultOutcomeDest(defaultOutcome)" is-editable="editabilityService.isEditable()" class="protractor-test-response-body">
                  </answer-group-editor>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </md-card>

  <md-card style="margin: 20px 0px; padding: 0px;">
    <div ng-if="editabilityService.isEditableOutsideTutorialMode() && (getCurrentInteractionId() !== 'Continue')" class="oppia-add-rule-button-container">
      <button type="button" class="btn btn-default btn-lg oppia-add-response-button protractor-test-open-add-response-modal" ng-click="openAddAnswerGroupModal()">
        + Add New Oppia Response
      </button>
    </div>
  </md-card>

  <div style="margin: 20px 0px; padding: 0px;">
    <div ng-if="editabilityService.isEditableOutsideTutorialMode() && isCurrentInteractionTrainable()" class="oppia-add-rule-button-container" style="text-align: center;">
      <!-- TODO(bhenning): This abuses the MD cards and does not have a proper drop shadow like the other MD buttons. -->
      <button type="button" class="btn btn-default btn-lg oppia-add-response-button protractor-test-open-add-teach-oppia-modal" style="width: 49%; float: left;" ng-click="openTeachOppiaModal()">
        Teach Oppia
      </button>
      <button type="button" class="btn btn-default btn-lg oppia-add-response-button protractor-test-open-add-teach-oppia-modal" style="width: 49%; float: right;" ng-click="openTestOppiaModal()">
        Test Oppia
      </button>
    </div>
  </div>
</div>

<script type="text/ng-template" id="modals/addAnswerGroup">
  <div class="modal-header protractor-test-add-response-modal-header">
    <h3>Add Response</h3>
  </div>

  <div class="modal-body">
    <form name="addAnswerGroupForm.outcomeDetailsForm" class="form-inline protractor-test-add-response-details">
      <div class="oppia-rule-details-header">
        <strong>If the learner's answer...</strong>
      </div>

      <rule-editor rule="tmpRule" is-editable="editabilityService.isEditable()" is-editing-rule-inline="false">
      </rule-editor>

      <br>

      <outcome-feedback-editor outcome="tmpOutcome">
      </outcome-feedback-editor>

      <br>

      <outcome-destination-editor outcome="tmpOutcome">
      </outcome-destination-editor>
    </form>
  </div>

  <div class="modal-footer">
    <button class="btn btn-default protractor-test-close-add-response-modal" ng-click="cancel()">Cancel</button>
    <button class="btn btn-success protractor-test-add-new-response" ng-click="saveResponse(false)" ng-disabled="addAnswerGroupForm.outcomeDetailsForm.$invalid || isSelfLoopWithNoFeedback(tmpOutcome)">Save Response</button>
    <button class="btn btn-success protractor-test-add-new-response" ng-click="saveResponse(true)" ng-disabled="addAnswerGroupForm.outcomeDetailsForm.$invalid || isSelfLoopWithNoFeedback(tmpOutcome)">Save and Add Another</button>
  </div>
</script>

<script type="text/ng-template" id="modals/deleteAnswerGroup">
  <div class="modal-header">
    <h3>Delete Response</h3>
  </div>

  <div class="modal-body">
    <p>
      Are you sure you want to delete this response?
    </p>
  </div>

  <div class="modal-footer">
    <button class="btn btn-default" ng-click="cancel()">Cancel</button>
    <button class="btn btn-danger protractor-test-confirm-delete-response"
            ng-click="reallyDelete()">
      Delete Response
    </button>
  </div>
</script>

<script type="text/ng-template" id="modals/teachOppia">
  <div class="modal-header">
    <h3>Teach Oppia</h3>
  </div>

  <div class="modal-body">
    <form name="teachOppiaForm" class="form-inline">
      <div class="oppia-rule-details-header">
        <div>
          <strong ng-if="trainingData.length == 0">
            Oppia understands all the answers submitted for this question.
          </strong>

          <br>

          <training-panel ng-if="trainingData.length > 0" answer="trainingData[0].answer" answer-feedback="trainingData[0].feedback" classification="classification" on-create-answer-group="createAnswerGroup()" on-finish-training="finishTraining(true)">
          </training-panel>
        </div>
      <div>
    </form>
  </div>

  <div class="modal-footer">
    <button class="btn btn-success" ng-click="finishTraining(false)">Exit</button>
  </div>
</script>

<script type="text/ng-template" id="modals/testOppia">
  <div class="modal-header">
    <h3>Test Oppia</h3>
  </div>

  <div class="modal-body">
    <div class="oppia-rule-details-header">
      <demo-interaction-panel state-content="stateContent" input-template="inputTemplate" on-submit-answer="submitAnswer(answer)">
      </demo-interaction-panel>

      <form name="testOppiaForm" class="form-inline">
        <training-panel ng-if="trainingData.length > 0 && classification.feedbackIndex >= 0" answer="trainingData[0].answer" answer-feedback="trainingData[0].feedback" classification="classification" on-create-answer-group="createAnswerGroup()" on-finish-training="finishTesting(true)">
        </training-panel>
      </form>
      <div ng-if="classification.feedbackIndex === -1">
        <div>
          <span><strong>If Oppia encounters the answer:</strong></span>
        </div>

        <div>
          <div angular-html-bind="answerTemplate">
          </div>
        </div>

        <br>

        <div>
          <span><strong>it will reply with:</strong></span>
        </div>

        <div>
          <div angular-html-bind="trainingData[0].feedback">
          </div>
        </div>

        <br>

        <div>
          <span><strong>This is due to a specific rule. If you do not think this is right, you should change the rule directly referring to this answer.</strong></span>
        </div>

        <br>

        <button class="btn btn-default" ng-click="finishTesting(true)">Test Oppia Again</button>
      </div>
    <div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-success" ng-click="finishTesting(false)">Exit</button>
  </div>
</script>

<script type="text/ng-template" id="teaching/trainingPanel">
  <div class="form-inline" style="margin-bottom: 10px; border-top: 1px solid #e5e5e5;">
    <div style="margin-top: 10px;">
      <span><strong>If Oppia encounters the answer:</strong></span>
    </div>

    <div>
      <div angular-html-bind="answerTemplate">
      </div>
    </div>

    <br>

    <div>
      <span><strong>it will reply with:</strong></span>
    </div>

    <div>
      <div angular-html-bind="answerFeedback">
      </div>
    </div>

    <br>

    <div>
      <span><strong>Is this right?</strong></span>
    </div>

    <div>
      <button class="btn btn-default" ng-disabled="changingFeedbackIndex" ng-click="beginChangingFeedbackIndex()">No</button>
      <button class="btn btn-default" ng-disabled="changingFeedbackIndex" ng-click="confirmFeedbackIndex(classification.feedbackIndex)">Yes</button>
    </div>

    <br>

    <div ng-if="changingFeedbackIndex">
      <span><strong>Select correct feedback:</strong></span>
      <div angular-html-bind="inputTemplate">
      </div>
      <button class="btn btn-default" ng-if="!addingNewResponse" ng-click="beginAddingNewResponse()">New Response</button>
      <outcome-feedback-editor ng-if="addingNewResponse" outcome="classification.newOutcome">
      </outcome-feedback-editor>
      <button class="btn btn-default" ng-if="addingNewResponse" ng-click="confirmNewFeedback()">Save New Response</button>
    </div>
  </div>
</script>

<script type="text/ng-template" id="teaching/demoInteractionPanel">
  <div class="form-inline" style="margin-bottom: 20px;">
    <table class="preview-conversation-skin-card-row-container">
      <tr class="preview-conversation-skin-card-row">
        <td class="preview-conversation-skin-row-avatar" valign="top">
          <img class="preview-conversation-skin-row-avatar-img" src="/images/general/oppia_black_48px.png">
        </td>
        <td class="preview-conversation-skin-oppia-content">
          <div angular-html-bind="stateContent"></div>
        </td>
      </tr>
    </table>
    <div ng-if="interactionIsInline">
      <div class="preview-conversation-skin-inline-interaction">
        <table class="preview-conversation-skin-card-row-container" style="margin-bottom: 0;">
          <tr class="preview-conversation-skin-card-row">
            <td class="preview-conversation-skin-row-avatar" valign="top">
              <img class="preview-conversation-skin-row-avatar-img img-circle" ng-src="/images/general/user_mint_48px.png">
            </td>
            <td class="preview-conversation-skin-learner-input" angular-html-bind="inputTemplate">
            </td>
          </tr>
        </table>
      </div>
    </div>
    <div class="preview-conversation-skin-supplemental-interaction" ng-if="!interactionIsInline">
      <div>
        <md-card class="preview-conversation-skin-supplemental-card">
          <div angular-html-bind="inputTemplate">
          </div>
        </md-card>
      </div>
    </div>
  </div>
</script>
