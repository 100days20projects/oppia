<div ng-controller="InteractiveWidgetEditor" class="oppia-iframe-container">
  <div>
    <div class="span10">
      <div class="oppia-widget-preview">
        <!-- This iframe is dynamically resized based on its content. -->
        <iframe id="interactiveWidgetPreview" frameborder="0" width="100%" height="5px" seamless="seamless">
        </iframe>
      </div>
  
      <div>
        <label>
          <input type="checkbox" ng-model="widgetSticky">
          Use the previous state's widget if possible.
          <img class="oppia-help" src="/images/help.png"
              tooltip="If this option is selected, then if the reader comes to this state from a state that uses the same type of interactive widget, that widget (and any previous content entered by the reader) will be preserved. Otherwise, it will be replaced with a new one."
              tooltip-placement="right">
        </label>
      </div>
    </div>
    <div class="span2">  
      <span class="pull-right">
        <button ng-click="showChooseInteractiveWidgetModal()">
          Pick new interaction
        </button>
        <br><br>
        <span ng-if="!isEmpty(widgetCustomizationArgs)">
          <button ng-click="showCustomizeInteractiveWidgetModal()">
            Customize
          </button>
        </span>
      </span>
    </div>
  </div>

  <div><div class="span12"></div></div>

  <div>
    <span class="span1"></span>
    <div class="span11">
      <h4 id="rules">Answer classification rules</h4>

      <div ng-repeat="(handlerName, handler) in widgetHandlers">
        <h5>When readers <[handlerName]>:
          <img class="oppia-help" src="/images/help.png"
              tooltip="The reader's answer is evaluated against each of these rules. If one matches, the reader is sent to the corresponding destination state, and the corresponding piece of feedback will be shown."
              tooltip-placement="right">
        </h5>
        <table style="width: 100%">
          <tr ng-repeat="rule in handler" ng-hide="$last">
            <td style="width: 5%; vertical-align: top">
              <span ng-show="rule.feedback.length || !matchesCurrentStateId(rule.dest)">
                •
              </span>
              <span ng-hide="rule.feedback.length || !matchesCurrentStateId(rule.dest)">
                <i class="icon-warning-sign" title="This rule loops back to the same state and has no feedback, so it will probably confuse readers."></i>
              </span>
            </td>
            <td style="width: 70%; vertical-align: top">
              <span>
                Answer <[rule | parameterizeRuleDescription: widgetCustomizationArgs.choices]>
              </span>:
              <span ng-show="rule.dest == 'END' || rule.dest == stateId">
                (<[getStateNameForRule(rule.dest)]>,
              </span>
              <span ng-hide="rule.dest == 'END' || rule.dest == stateId">
                (<a href="/create/<[explorationId]>#/gui/<[rule.dest]>">
                  <[getStateNameForRule(rule.dest)]>,
                </a>
              </span>
              <span ng-bind-html="rule.feedback|truncate"></span>)
            </td>
            <td style="width: 5%; vertical-align: top"></td>
            <td style="width: 15%; vertical-align: top">
              <span>
                <a href="#" onclick="return false;" ng-click="openEditRuleModal(handlerName, $index)">Edit</a> |
              </span>
              <span ng-show="$index != 0">
                <a href="#" onclick="return false;" ng-click="swapRules(handlerName, $index, $index - 1)">⇑</a>
              </span>
              <span ng-hide="$index != 0">
                <span class="oppia-grayed">⇑</span>
              </span>

              <span ng-show="$index < handler.length - 2">
                | <a href="#" onclick="return false;" ng-click="swapRules(handlerName, $index, $index + 1)">⇓</a>
              </span>
              <span ng-hide="$index < handler.length - 2">
                | <span class="oppia-grayed">⇓</span>
              </span>

              <span>
                | <a href="#" onclick="return false;" ng-click="deleteRule(handlerName, $index)"> &times; </a>
              </span>
            </td>
          </tr>
          <tr ng-show="widgetId != 'Continue'">
            <td style="width: 5%; vertical-align: top">
              •
            </td>
            <td style="width: 70%; vertical-align: top" class="oppia-lightly-grayed">
              (<em>New rules will be added here.</em>)
            </td>
            <td style="width: 5%; vertical-align: top"></td>
            <td style="width: 15%; vertical-align: top">
              <a href="#" onclick="return false;" ng-click="openAddRuleModal(handlerName)">Add new rule</a>
            </td>
          </tr>
          <tr>
            <td style="width: 5%; vertical-align: top">
              <span ng-show="handler[handler.length - 1].feedback.length || !matchesCurrentStateId(handler[handler.length - 1].dest)">
                •
              </span>
              <span ng-hide="handler[handler.length - 1].feedback.length || !matchesCurrentStateId(handler[handler.length - 1].dest)">
                <i class="icon-warning-sign" title="This rule loops back to the same state and has no feedback, so it will probably confuse readers."></i>
              </span>
            </td>
            <td style="width: 70%; vertical-align: top">
              <span>
                <[getDefaultRule(handlerName) | parameterizeRuleDescription: widgetCustomizationArgs.choices]>
              </span>:
              <span ng-show="getDefaultRule(handlerName).dest == 'END' || getDefaultRule(handlerName).dest == stateId">
                (<[getStateNameForRule(getDefaultRule(handlerName).dest)]>,
              </span>
              <span ng-hide="getDefaultRule(handlerName).dest == 'END' || getDefaultRule(handlerName).dest == stateId">
                (<a href="/create/<[explorationId]>#/gui/<[getDefaultRule(handlerName).dest]>">
                  <[getStateNameForRule(getDefaultRule(handlerName).dest)]>,
                </a>
              </span>
              <span ng-bind-html="getDefaultRule(handlerName).feedback|truncate"></span>)
            </td>
            <td style="width: 5%; vertical-align: top"></td>
            <td style="width: 15%; vertical-align: top">
              <span>
                <a href="#" onclick="return false;" ng-click="openEditRuleModal(handlerName, handler.length - 1)">Edit</a> |
              </span>
              <span class="oppia-grayed"> ⇑ </span>
              |
              <span class="oppia-grayed"> ⇓ </span>
              |
              <span class="oppia-grayed"> &times; </span>
            </td>
          </tr>
        </table>
      </div>

      <br><br>

      <div ng-show="!isEmpty(unresolvedAnswersMap)">
        <h4>Answers received</h4>
        <div ng-repeat="item in unresolvedAnswersMap | orderBy:'-count'">
          <span ng-show="item.count == 0">
            <del>
              <[item.answer]>
            </del>
          </span>
          <span ng-show="item.count > 0">
            <[item.answer]>
            (<em>submitted <[item.count]> time<span ng-show="item.count != 1">s</span></em>)
            <a href="#" onclick="return false;" ng-click="deleteUnresolvedAnswer(item.answer)" class="pull-right">Delete</a>
          </span>
        </div>
      </div>
    </div>
  </div>

  <script type="text/ng-template" id="modals/chooseInteractiveWidget">
    <div class="modal-header">
      <h3>Choose an Interactive Widget</h3>
    </div>

    <div class="modal-body">
      <iframe src="/widgetrepository?iframed=true&interactive=true"
              width="100%" height="400px" frameborder="0"
              id="interactiveWidgetRepository">
      </iframe>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn" ng-click="cancel()">
        Cancel
      </button>
    </div>
  </script>


  <script type="text/ng-template" id="modals/ruleEditor">
    <div class="modal-header">
      <h3><[modalTitle]></h3>
    </div>

    <div class="modal-body">
      <div ng-if="!tmpRule.description">
        <div ng-repeat="(description, name) in existingRules" class="oppia-rule">
          <span ng-bind-html="description | bracesToText"></span>
          <button type="button" class="pull-right"
                  ng-click="selectRule(description, name)">
            Select
          </button>
        </div>
      </div>

      <div ng-if="tmpRule.description">
        <span ng-if="tmpRule.description != 'Default'">
          Answer
        </span>
        <span ng-repeat="item in tmpRuleDescriptionFragments track by $index">
          <span ng-if="item.type == 'select'">
            <select ng-model="tmpRule.inputs[item.varName]" ng-options="choice.id as choice.val for choice in getExtendedChoiceArray(widgetCustomizationArgs.choices.value)">
            </select>
          </span>
          <span ng-if="item.type == 'input'">
            <input type="text" required ng-model="tmpRule.inputs[item.varName]">
          </span>
          <span ng-if="item.type == 'list'">
            <list items="tmpRule.inputs[item.varName]"></list>
          </span>
          <span ng-if="item.type == 'html'">
            <[item.text]>
          </span>
        </span>

        <hr>
        <div>
          Destination:
          <select ng-model="tmpRule.dest" ng-required="tmpRule.dest != '?'"
                  ng-options="getDestName(id) for id in allDests">
          </select>

          <input type="text" ng-model="tmpRule.destNew"
                 ng-required="tmpRule.dest == '?'" ng-show="tmpRule.dest == '?'">
        </div>
        <div>
          <p>Feedback for the reader (chosen at random from the following):</p>
          <list large-input="true" items="tmpRule.feedback" add-item-text="Add feedback message"></list>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <span ng-show="tmpRule.description">
        <button type="button" class="btn" ng-click="save()">
          Use this rule
        </button>
      </span>

      <!-- The next button is shown only when a new rule is being added. -->
      <span ng-show="tmpRule.description && tmpRule.index == null">
        <button type="button" class="btn" ng-click="resetTmpRule()">
          Return to rule menu
        </button>
      </span>

      <span ng-show="!tmpRule.description && tmpRule.index == null">
        <button type="button" class="btn" ng-click="cancel()">
          Cancel
        </button>
      </span>
    </div>
  </script>

</div>
