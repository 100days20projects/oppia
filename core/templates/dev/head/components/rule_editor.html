<div>
  <div ng-if="!ruleEditorIsOpen && isTmpRule !== 'true'">
    <div class="row oppia-readonly-rule-container">
      <div class="col-lg-10 col-md-10 col-sm-10">
        <div class="oppia-rule-sort-handle" ng-if="!isDefaultRule()">
          <span class="glyphicon glyphicon-sort oppia-rule-sort-arrows"></span>
        </div>

        <div class="container-fluid">
          <div class="row oppia-readonly-rule-tile">
            <div class="col-lg-10 col-md-10 col-sm-10" style="margin-left: -5px;">
              <span>
                <span ng-if="rule.description !== 'Default'">
                  <span angular-html-bind="rule | parameterizeRuleDescription: choices"></span>
                </span>
                <span ng-if="rule.description === 'Default'">
                  If none of the above rules apply...
                </span>
              </span>

              <ul ng-if="isRuleConfusing() || rule.feedback.length > 0">
                <li>
                  <span ng-if="isRuleConfusing()">
                    <span class="glyphicon glyphicon-warning-sign"></span>
                    <span class="oppia-warning-text">
                      Please give some feedback for this self-loop.
                    </span>
                  </span>
                  <span ng-if="rule.feedback.length > 0">
                    <em>
                      <[rule.feedback[0]]>
                      <span ng-if="rule.feedback.length > 1">...</span>
                    </em>
                  </span>
                </li>
              </ul>
            </div>

            <div class="col-lg-2 col-md-2 col-sm-2">
              <span ng-if="rule.dest !== getActiveStateName()">
                <span class="glyphicon glyphicon-arrow-right"></span>
                <a href="/create/<[explorationId]>#/gui/<[getEscapedDest()]>" ng-if="rule.dest !== 'END'">
                  <[rule.dest]>
                </a>
                <span ng-if="rule.dest === 'END'">END</span>
              </span>
              <span ng-if="rule.dest === getActiveStateName()">⟳</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-2 col-md-2 col-sm-2">
        <div class="pull-right" ng-if="isEditable">
          <button type="button" class="btn btn-default btn-xs oppia-rule-edit-button" ng-click="openRuleEditor()">
            <span class="glyphicon glyphicon-pencil" title="Edit Rule"></span>
          </button>
          <button type="button" class="btn btn-default btn-xs" ng-if="!isDefaultRule()" ng-click="deleteRule()">
            <span class="glyphicon glyphicon-remove" title="Remove Rule"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div ng-if="isEditable && (ruleEditorIsOpen || isTmpRule === 'true')">
    <div class="oppia-rule-bubble">
      <span ng-if="rule.description !== 'Default'">
        <form class="form-inline" role="form">
          Answer
          <rule-type-selector class="protractor-test-rule-description" all-rule-types="allRuleTypes" local-value="$parent.$parent.currentRuleDescription" on-selection-change="selectNewRuleType()">
          </rule-type-selector>

          <span ng-repeat="item in ruleDescriptionFragments track by $index">
            <span ng-if="item.type == 'select'" style="color: black;">
              <select ng-model="rule.definition.inputs[item.varName]" ng-options="choice.id as choice.val for choice in getExtendedChoiceArray(choices)">
              </select>
            </span>

            <span ng-if="item.type != 'select' && item.type != 'noneditable'">
              <object-editor obj-type="<[item.type]>" is-editable="isEditable" always-editable="true" value="rule.definition.inputs[item.varName]" style="color: black;"></object-editor>
            </span>
            <span ng-if="item.type == 'noneditable'">
              <[item.text]>
            </span>
          </span>
        </form>
      </span>

      <span ng-if="rule.description === 'Default'">
        If none of the above rules apply...
      </span>
    </div>

    <div class="oppia-feedback-and-dest" ng-class="{'oppia-lightly-grayed': isTmpRule === 'true'}">
      <div class="oppia-feedback-bubble">
        <span ng-if="rule.feedback.length > 0">
          Feedback options
          <span ng-if="rule.feedback.length > 1">
            (<em>one is chosen at random</em>):
          </span>
        </span>
        <span ng-if="rule.feedback.length == 0">
          <em>No feedback specified.</em>
        </span>

        <schema-based-editor schema="RULE_FEEDBACK_SCHEMA" local-value="$parent.rule.feedback" disabled="$scope.isTmpRule === 'true'">
        </schema-based-editor>
      </div>

      <div class="oppia-dest-bubble">
        <div class="oppia-align-center">
          <strong>Destination:</strong><br />
          <select2-dropdown width="150" item="rule.dest" choices="destChoices" placeholder="Type destination state name" new-choice-regex="^[A-Z a-z0-9]+$">
          </select2-dropdown>
          <span ng-if="rule.dest == stateName"> ⟳ </span><br />
        </div>
      </div>
    </div>

    <div style="margin-top: 5px; margin-bottom: 5px;">
      <button type="button" class="btn btn-success protractor-test-save-rule" ng-disabled="!rule.description" ng-click="saveThisRule()">Save Rule</button>
      <button type="button" class="btn btn-default" ng-click="cancelThisEdit()">Cancel</button>
    </div>
  </div>
</div>
